# Setting up Django database with credentials from Vault
Using [12factor-vault](https://github.com/jdelic/12factor-vault/) and [django-postgresql-setrole](https://github.com/jdelic/django-postgresql-setrole).

For local testing ran postgres and vault containers in the same network (possibly create the network with `docker network create django`):
```
export POSTGRES_PASSWORD=YOUR_POSTGRES_PASSWORD_HERE
docker run --rm --name postgres --network django --hostname postgres -p 5432:5432 -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} -e POSTGRES_USER=postgres -e POSTGRES_DB=postgres postgres:alpine
docker run --rm --network django -p 8200:8200 --cap-add=IPC_LOCK --name vault -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} vault:latest
```
Note the Vault root token, which I was using for authentication.
Further is the required setup for [django-postgresql-setrole](https://github.com/jdelic/django-postgresql-setrole), which required quite some modification.

## Necessary commands in postgres container
```
docker exec -ti postgres sh
su postgres -c "createuser -D -E -I -l -r -S vaultadmin"
su postgres -c "createuser -D -E -I -L -R -S django_owner"
su postgres -c "createdb -E utf8 -O django_owner django"
```
## Necessary commands in vault container
```
docker exec -ti vault sh
VAULT_TOKEN=YOUR_TOKEN_HERE
DATABASE_NAME=django
DATABASE_OWNERROLE=django_owner
VAULT_DATABASE_PATH=django-auth

export VAULT_ADDR='http://0.0.0.0:8200'
vault auth $VAULT_TOKEN
vault mount -path=$VAULT_DATABASE_PATH database
vault write $VAULT_DATABASE_PATH/config/$DATABASE_NAME \
    plugin_name=postgresql-database-plugin \
    allowed_roles="fullaccess" \
    connection_url="postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/?sslmode=disable" # Disable SSL mode for connection config while testing
    # Note the insecure password for postgres user here. It MUST be changed to something safer outside of testing environment.

vault write $VAULT_DATABASE_PATH/roles/fullaccess \
  db_name=$DATABASE_NAME \
  creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN ENCRYPTED PASSWORD '{{password}}' IN ROLE \"${DATABASE_OWNERROLE}\" INHERIT NOCREATEROLE NOCREATEDB NOSUPERUSER NOREPLICATION NOBYPASSRLS;" \
  revocation_statements="DROP ROLE \"${DATABASE_OWNERROLE}\";"
  default_ttl="1h" \
  max_ttl="24h"

vault read $VAULT_DATABASE_PATH/roles/fullaccess # To confirm that setup has been successful
vault read $VAULT_DATABASE_PATH/creds/fullaccess # To confirm that username and password is getting generated by Vault
```

## Configuration in Django's settings
First, add to your INSTALLED_APPS:
```
'vault12factor',
'postgresql_setrole',
```
And then the actual [12factor-vault](https://github.com/jdelic/12factor-vault/)
```
from vault12factor import VaultCredentialProvider, VaultAuth12Factor, DjangoAutoRefreshDBCredentialsDict, monkeypatch_django
if DEBUG and not VaultAuth12Factor.has_envconfig():
    SECRET_KEY = "SECRET_KEY_FOR_DEBUG_GOES_HERE"  # FOR DEBUG ONLY!
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': 'authserver.sqlite3',
        }
    }
else:
    if DEBUG:
        SECRET_KEY = "SECRET_KEY_FOR_DEBUG_GOES_HERE"  # FOR DEBUG ONLY!
    VAULT = VaultAuth12Factor.fromenv()
    CREDS = VaultCredentialProvider("http://vault:8200/", VAULT,
                                    os.getenv("VAULT_DATABASE_PATH", "django-auth/creds/fullaccess"),
                                    os.getenv("VAULT_CA", None), False, #The ssl_verify: false
                                    DEBUG)
    DATABASES = {
            'default': DjangoAutoRefreshDBCredentialsDict(CREDS, {
                'ENGINE': 'django.db.backends.postgresql',
                'NAME': os.getenv("DATABASE_NAME", "django"),
                'USER': CREDS.username,
                'PASSWORD': CREDS.password,
                'HOST': 'postgres', # docker container hostname
                'PORT': '5432',
                # requires django-postgresql-setrole
                'SET_ROLE': os.getenv("DATABASE_OWNERROLE", "django_owner")
            }),
            }
```

## Notes
Also remember update your pip requirements file with:
```
12factor-vault
django-postgresql-setrole
```

Then I was running Django, Gunicorn container via docker-compose and passing parameters required by 12factor-vault
```
- VAULT_TOKEN=${VAULT_TOKEN}
- DATABASE_NAME=django
- DATABASE_OWNERROLE=django_owner
- VAULT_DATABASE_PATH=django-auth/creds/fullaccess
```

To not have VAULT_TOKEN in the compose file, exported the variable like so:
`export VAULT_TOKEN=YOUR_TOKEN_HERE`